package wondough;

import java.sql.*;

public class Vulnerability1 {

	// run tests for vulnerability 1
	public void test(WondoughUser hacker) {

		String test1 = this.testUserIdIsSetOnCreation(hacker);
		String test2 = "failed";
		try {
			test2 = this.testUserIdIsSetInAuthorisedApps(hacker);
		} catch (SQLException e) {
			System.out.println(e.toString());
		}

		System.out.println("Vulnerability 1: \tTest 1 " + test1);
		System.out.println("\t\t\tTest 2 " + test2);
		System.out.println();
	}

	// test to see whether usedId is set on creation of a WondoughUser object
	private String testUserIdIsSetOnCreation(WondoughUser hacker) {
		if (hacker.getID() == -1) return "passed";
		else return "failed";
	}

	// test to see whether userId is set in database
	private String testUserIdIsSetInAuthorisedApps(WondoughUser hacker) throws SQLException {
		String rt = "failed";

		// run createApp
		DbConnection db = Program.getInstance().getDbConnection();
		db.createApp(hacker);

		// get connection to the database
		String url = "jdbc:sqlite:" + "wondough.db";
		Connection connection = DriverManager.getConnection(url);

		// run SQL query to check the userID is correctly set in authorised_apps
		Statement stmt = null;
        String query = "SELECT user FROM authorised_apps WHERE user=-1;";

        try {
            stmt = connection.createStatement();
            ResultSet rs = stmt.executeQuery(query);

            while(rs.next()) {
                if (rs.getInt("user") == -1) rt = "passed";
				else rt ="failed";
            }
        } catch (SQLException e ) {
            System.out.println("failed2" + e.toString());
        } finally {
            if (stmt != null) { stmt.close(); }
        }

		return rt;
    }
}

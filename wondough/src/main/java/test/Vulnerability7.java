package wondough;

import java.sql.*;

public class Vulnerability7 {

	// run tests for vulnerability 7
	public void test() {
		String test1 = this.testUserWithSameUsernameDenied();
		String test2 = this.testUserWithDifferentUsernameAllowed();

		System.out.println("Vulnerability 7: \tTest 1 " + test1);
		System.out.println("\t\t\tTest 2 " + test2);
		System.out.println();
	}

	// test whether a creating a user with a used login is denied
	private String testUserWithSameUsernameDenied() {
		// get database
		DbConnection db = Program.getInstance().getDbConnection();

		// create victim with username victim
		WondoughUser victim = new WondoughUser(-1, "victim");
		victim.setIterations(1);
		victim.setKeySize(1);
		victim.setHashedPassword("a");
		victim.setSalt("a");

		// create hacker with username victim
		WondoughUser hacker = new WondoughUser(-1, "victim");
		hacker.setIterations(1);
		hacker.setKeySize(1);
		hacker.setHashedPassword("a");
		hacker.setSalt("a");

		boolean v;
		boolean h;
		try {
			// try to create both users
			v = db.createUser(victim);
			h = db.createUser(hacker);
		} catch (SQLException e) {
			return "failed" + e.toString();
		}

		// if both users are created, fail the test, otherwise pass
		if (v == h) return "failed";
		else return "passed";
	}

	// test whether users with different usernames are still accepted
	private String testUserWithDifferentUsernameAllowed() {
		DbConnection db = Program.getInstance().getDbConnection();

		// create user1 with username user1
		WondoughUser user1 = new WondoughUser(-1, "user1");
		user1.setIterations(1);
		user1.setKeySize(1);
		user1.setHashedPassword("a");
		user1.setSalt("a");

		// create user2 with username user2
		WondoughUser user2 = new WondoughUser(-1, "user2");
		user2.setIterations(1);
		user2.setKeySize(1);
		user2.setHashedPassword("a");
		user2.setSalt("a");

		boolean u1;
		boolean u2;
		try {
			// try to create both users
			u1 = db.createUser(user1);
			u2 = db.createUser(user2);
		} catch (SQLException e) {
			return "failed" + e.toString();
		}

		// if both users are created, pass the test, otherwise fail
		if (u1 == u2) return "passed";
		else return "failed";
	}
}

package wondough;

import java.util.*;
import java.net.*;
import java.io.*;

public class Vulnerability5 {

	// run tests for vulnerability 5
	public void test() {
		String test1 = this.testForPredictableRequestTokens();
		String test2 = this.testForPredictableAccessTokens();

		System.out.println("Vulnerability 5: \tTest 1 " + test1);
		System.out.println("\t\t\tTest 2 " + test2);
		System.out.println();
	}

	// test for predicatable request tokens
	public String testForPredictableRequestTokens() {
		// get security configuration
		SecurityConfiguration config = Program.getInstance().getSecurityConfiguration();
		String[] requestTokens = {"1", "2", "3", "4", "5", "6", "7", "8", "9", "10"};

        // for each request token send a http request
		for (int i = 0; i < 10; i++) {
			try {
				// send request to exchange tokens
				URL url = new URL("http://localhost:8000/exchange");
	            HttpURLConnection con = (HttpURLConnection)url.openConnection();
	            con.setRequestMethod("POST");
				con.setDoOutput(true);

				// append current token to the request
	            DataOutputStream out = new DataOutputStream(con.getOutputStream());
	            out.writeBytes(URLEncoder.encode("?token") + "=" + URLEncoder.encode(config.sha(requestTokens[i])));
	            out.flush();
	            out.close();

				// get the response status code and check that it's OK
	            int status = con.getResponseCode();
				con.disconnect();
				// if response status is 200, request was succesful so fail
	            if(status == 200) return "failed";
			} catch (IOException ex) {
				return "failed" + ex.toString();
			}
		}

        // return passed if the request token was not guessed
        return "passed";
	}

	// test for predicatable access tokens
	public String testForPredictableAccessTokens() {
		// get security configuration
		SecurityConfiguration config = Program.getInstance().getSecurityConfiguration();
		String[] accessTokens = {"1", "2", "3", "4", "5", "6", "7", "8", "9", "10"};

        // for each request token send a http request
		for (int i = 0; i < 10; i++) {
			try {
				// send request to exchange tokens
				URL url = new URL("http://localhost:8000/transactions");
	            HttpURLConnection con = (HttpURLConnection)url.openConnection();
	            con.setRequestMethod("POST");
				con.setDoOutput(true);

				// append current token to the request
	            DataOutputStream out = new DataOutputStream(con.getOutputStream());
	            out.writeBytes(URLEncoder.encode("?token") + "=" + URLEncoder.encode(config.sha(accessTokens[i])));
	            out.flush();
	            out.close();

				// get the response status code and check that it's OK
	            int status = con.getResponseCode();
				con.disconnect();
				// if response status is 200, request was succesful so fail
	            if(status == 200) return "failed";
			} catch (IOException ex) {
				return "failed" + ex.toString();
			}
		}

        // return passed if the access token was not guessed
        return "passed";
	}
}
